# [AWS NAT 게이트웨이 구성하기](https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/vpc-nat-gateway.html#nat-gateway-creating)

## 사전 필요 개념

### NAT

- 내부 네트워크의 사설IP 주소를 외부네트워크의 공인IP주소로 변환하는 기술
- NAT를 통하면 내부->외부로 request는 되지만 반대반향 request는 불가
- AWS에선 NAT 인스턴스를 지원했으나, 현재는 NAT Gateway형태로 서비스 제공됨

### 필요한 상황

- 외부 인터넷 접속시 개별 서버의 주소를 노출하지 않고, 별도의 단일 소스IP로만 노출되도록할 때 사용
- e.g. 보안
- e.g. 클러스터 스케일아웃시 새 노드 IP에 대한 번거로운 인가절차 생략

### VPC(Virtual Private Cloud)와 Subnet

- NAT GW 설정 전, VPC와 Subnet이 필요
- VPC가 큰 네트워크 단위고, VPC안에 속한 작은 단위가 Subnet
- e.g. VPC에 큰 private ip 대역을 할당하고, Subnet마다 세부 대역으로 나눠 쓰는 개념
  - VPC: `172.31.0.0/16`(약65000개)
  - Subnet:
    - `172.31.0.0/20`(약 4000개)
    - `172.31.16.0/20`(약 4000개)
    - `172.31.32.0/28`(약 10개) ...
- VPC내부 인스턴스 간 private ip로 통신가능
- Subnet은 Public과 Private으로 나눠짐
  - Private: 내부 전용. private ip만 사용가능. 외부 연결시 NAT로 내부->외부 방향만 가능
  - Public: 라우팅테이블에서 인터넷 게이트웨이로 연결된 규칙이 있는 경우, 이를 퍼블릿 서브넷이라고 한다. 개별 인스턴스 단위로 Public IP가 등록하여 자유로운 외부 통신 가능

### 네트워크 경계 그룹

- `ap-northeast-2` 와 같은 것을 의미

### 가용영역(Availability Zone, AZ)

- ap-northeast-2a, ap-northeast-2b, ap-northeast-2c, ap-northeast-2d 와 같이 표현되는 것들
- 실제 AWS 데이터센터 위치를 의미
- 한 Subnet은 한 가용영역에 종속됨
- Failure 방지를 위해 여러 Subnet, 가용영역에 걸쳐친 네트워크가 VPC

### 참고

- `AWS NAT GW는 특정 서브넷에 소속`되는 개념이다.
- 같은 VPC 내라면 가용영역, 서브넷에 상관없이 NAT GW에 자유로이 접근가능
  - 하지만 여러 가용영역에 있는 인스턴스들이 하나의 NAT GW를 쓰는 것은 Failure상황 때문에 비권장사항
  - `각 가용영역마다 최소 1개의 NAT GW`를 구성하여 외부로 접근하는 것이 좋다.
  - `같은 가용영역 내라면 (같은 서비스 목적일 경우) 서브넷마다 별도 NAT GW를 구축할 필요는 없이` 하나의 NAT GW를 쓰면 된다.

### 라우팅 테이블

- [라우팅 테이블 생성 방법](https://docs.aws.amazon.com/ko_kr/vpc/latest/userguide/WorkWithRouteTables.html#SubnetRouteTables)
- 서브넷 내 트래픽이 어떻게 라우팅될지 결정
- 서브넷 내 모든 인스턴스 및 NAW GW는 라우팅 테이블의 규칙을 따른다.
  - 개별 인스턴스에서 라우팅 테이블에 등록된 목적지IP로 request를 보내면 NAT GW를 거쳐 포워딩된다. 이 과정에서 트래픽의 소스IP가 변조된다.
  - 특정 인스턴스만 해당 GW를 쓰게 하려면, 특정 서브넷 하나에 인스턴스를 모두 격리해야 한다.
- AWS의 라우팅 테이블은 VPC의 하위항목이고, 개별 서브넷과 연결되어 사용되는 개념이다.
- `하나의 서브넷은 하나의 라우팅 테이블만 가진다.`
- 하나의 라우팅 테이블은 여러 서브넷에서 사용될 수 있다.
- `서브넷이 VPC의 default 라우팅테이블을 사용 중일 때, 새로운 라우팅 테이블이 연결되면 default 라우팅테이블과의 연결은 해제`된다.
  - 기존 서브넷에 새로운 라우팅테이블을 연결할 때 조심하자. 다른 서비스가 먹통될 수 있다.
- 라우팅 테이블 작성방법
  - 라우팅 테이블은 목적지IP 기준으로 트래픽을 분류한다.
  - 소스IP로 트래픽 분류는 불가
  - 라우팅 테이블 컬럼에 한글로 "대상"이 두 개인데 첫번째 대상이 목적지IP를 의미, 두번째 대상이 경유할 GW를 의미한다.
  - 라우팅 테이블 내에서 목적지IP가 겹치는 규칙이 있는 경우, 더 구체적인 규칙을 우선적용한다. 앞서 처리된 트래픽은 이후 규칙에 적용받지 않는다. (중복처리 안됨)
    - e.g. `192.168.0.19/32가 192.168.0.0/24, 0.0.0.0/0보다 우선 적용`된다.

### 인터넷 게이트웨이

- AWS EC2인스턴스의 외부 인터넷 연결은 자동으로되는 것이 아니다.
- 외부 인터넷 연결시 해당 서브넷에서 인터넷 게이트웨이로 향하는 라우팅 규칙이 설정되어 있어야 한다.
- NAT GW를 사용할 때도, NAT GW가 소속된 서브넷에 인터넷 게이트웨이로 향하는 라우팅규칙이 있어야 외부 인터넷 연결이 가능하다.

### 요약

- AWS NAT GW 쓰려면 라우팅테이블이 필요하고, AWS NAT GW와 라우팅테이블 모두 서브넷 기준으로 등록하는 개념이라고 보면 된다.
- 새로운 서비스에 NAT 사용시, 새로운 서브넷을 생성하여 인스턴스들을 격리하는 것이 깔끔하다.
- 기존 서브넷을 유지해야 한다면, 다른 서비스에 영향이 가지않도록 기존 라우팅테이블의 정보를 포함하여 새로운 라우팅테이블을 만들어 준다.
- `신규 서비스는 NAT 필요유무를 가급적 초기판단하여 개별 서브넷으로 시작`하자. NAT와 관련된 모든 것들(GW, Elastic IP, instance 등)은 동일한 서브넷에 있어야 하며, 생성된 이후에 이전은 불가능하다. 수동으로 재생성 해야한다.
- `NAT GW는 반드시 퍼블릭 서브넷에 있어야 한다.` 특히 NAT GW도 소속된 서브넷의 라우팅테이블을 따르기 때문에, 인터넷 게이트웨이로 트래픽을 내보내주는 라우팅 규칙이 있어야 한다.

### 주의사항

- 일반적으로 NAT GW는 항상 Public Subnet에 있어야하고, 이 NAT GW는 Private Subnet에 있는 인스턴스들이 활용하는 목적으로 사용된다.
- `Public Subnet의 인스턴스에 NAT를 적용할 때도 다른 Public Subnet에 있는 NAT GW를 사용하는 것이 좋다`
- `하나의 Public Subnet에 인스턴스와 NAT GW가 모두 있으면 라우팅이 꼬여서 네트워크 루핑이 발생`할 수 있다. 특정 목적지로 가는 트래픽이 NAT GW로 라우팅된 후, NAT GW도 동일한 라우팅 규칙에 의해 자기자신한테 트래픽을 보내기 때문이다.
