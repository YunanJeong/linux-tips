# TLS

- 많이 들었지만 여전히 익숙치않은 TLS 보안연결
- 데이터 엔지니어, 플랫폼 엔지니어, 서버 개발자 입장에서 빠르게 구축하기 위해 핵심만 정리

## 인증서?

- 인증서 파일을 가진 엔티티(주로 서버)가 통신 상대(주로 클라이언트)에게 **자기 자신을 증명**하기 위한 것
  - e.g. 서버 인증서: 클라이언트가 서버에 접근시, 서버가 자기 자신을 증명하기 위해 서버 시스템 내 보관하는 인증서 파일
  - e.g. 클라이언트 인증서: 클라이언트가 서버에 접근시, 클라이언트가 자기 자신을 증명하기 위해 클라이언트 시스템 내 보관하는 인증서 파일
- 자체서명 인증서
  - CA(인증기관)를 거치지 않고, `openssl` 등으로 개발자가 직접 수동생성한 인증서
- 루트 인증서
  - 인증 기관(CA)이 발급한 인증서 중 최상위에 위치하는 인증서로, 다른 인증서의 신뢰성을 검증하는 데 사용. 루트 인증서는 자체 서명되어 있으며, 공인된 인증 기관에 의해 발급
  - 루트 인증서가 보관된 곳을 루트 인증서 보관소라고 하고, 로컬 시스템 내에 저장되어있음.

## Mutual TLS

- 서버가 클라이언트에게 자기자신을 증명하기도 하지만, 클라이언트가 서버에게 옳은 클라이언트라는걸 증명할 떄도 있다. 이처럼 서버 인증, 클라인증을 모두 하는 것을 Mutual TLS라고 한다.
- 보안강화 필요에따라 Mutual TLS를 하면 좋겠지만, 클라인증없이 서버인증만 해도 일반적인 TLS 요건은 만족되는 것으로 본다.
- `서버인증만 하는 기준으로 이후를 기술한다.`

## TLS 구축시 필요한 파일들 핵심만!

1. 일반적인 TLS 세팅 (공인 인증서 사용)
   - 서버:
     - 공인 인증서 파일 (e.g., certificate.crt)
     - 개인 키 파일 (e.g., private.key)
     - 공개 키: 개인 키로부터 생성하며, 인증서 생성시 필요. 인증서에 포함되므로 통신시 별도 파일로 필요치는 않음
   - 클라이언트:
     - 클라이언트 앱에서 TLS 옵션 활성화만 해주면됨
     - 클라이언트가 브라우저(https)일 경우 별도 설정 필요 없음

2. CA 대신 자체 서명 인증서로 TLS 암호화만 적용하기 (TLS 요건 불만족)
   - 서버:
     - 자체 서명 인증서 파일 (e.g., certificate.crt)
     - 개인 키 파일 (e.g., private.key)
     - 공개 키: 개인 키로부터 생성하며, 인증서 생성시 필요. 인증서에 포함되므로 통신시 별도 파일로 필요치는 않음
   - 클라이언트:
     - 클라이언트 앱에서 TLS 옵션 활성화
     - 연결 시 경고 무시 (추가 설정 없이 경고 무시하고 연결)

3. 자체 서명 인증서로 TLS 요건 만족하기 (암호화 + 서버 인증)
   - 서버:
     - 자체 서명 인증서 파일 (e.g., certificate.crt)
     - 개인 키 파일 (e.g., private.key)
     - 공개 키 파일: 개인 키로부터 생성하며, 인증서 생성시 필요. 인증서에 포함되므로 통신시 별도 파일로 필요치는 않음
   - 클라이언트:
     - 자체 서명 인증서를 신뢰할 수 있는 인증서로 추가
     - 클라이언트 시스템의 신뢰할 수 있는 인증서 저장소(로컬 경로, 쿠버네티스 Secret 등)에 자체 서명 인증서 추가

---

# TLS 구축 절차 핵심만

## TLS 세팅 1. 일반적인 TLS 세팅 (공인 인증서 사용)

1. 개인 키 생성
   - 명령어: `openssl genrsa -out private.key 2048`

2. 인증서 요청 파일(CSR) 생성
   - 명령어: `openssl req -new -key private.key -out request.csr`
   - CSR에 공개 키 포함.
   - 공개 키는 개인 키로 부터 생성해야하는 것

3. 인증서 발급 요청
   - CSR 파일을 인증 기관(CA)에 제출하여 인증서 발급

4. 서버에 인증서 설치
   - 서버 설정 파일에 인증서 경로와 개인 키 경로 지정

5. 서버 소프트웨어 설정
   - TLS 지원 설정 활성화
   - 포트 번호 및 프로토콜 설정

6. 테스트 및 검증
   - 클라이언트에서 서버로 연결 테스트
   - 인증서 유효성 및 암호화 통신 확인

## TLS 세팅 2.  자체 서명 인증서로 통신 암호화만 적용하기 (TLS요건 불만족)

1. 개인 키 생성
   - 명령어: `openssl genrsa -out private.key 2048`

2. 인증서 요청 파일(CSR) 생성
   - 명령어: `openssl req -new -key private.key -out request.csr`
   - CSR에 공개 키 포함

3. 자체 서명 인증서 생성
   - 명령어: `openssl x509 -req -days 365 -in request.csr -signkey private.key -out certificate.crt`

4. 서버에 인증서 설치
   - 서버 설정 파일에 인증서 경로와 개인 키 경로 지정

5. 서버 소프트웨어 설정
   - TLS 지원 설정 활성화
   - 포트 번호 및 프로토콜 설정

6. 테스트 및 검증
   - 클라이언트에서 서버로 연결 테스트
   - 자체 서명 인증서 경고 무시하고 암호화 통신 확인

## TLS 세팅 3. 자체 서명 인증서로 TLS 요건 만족하기 (암호화 + 서버 인증)

1. 개인 키 생성
   - 명령어: `openssl genrsa -out private.key 2048`

2. 인증서 요청 파일(CSR) 생성
   - 명령어: `openssl req -new -key private.key -out request.csr`
   - CSR에 공개 키 포함

3. 자체 서명 인증서 생성
   - 명령어: `openssl x509 -req -days 365 -in request.csr -signkey private.key -out certificate.crt`

4. 서버에 인증서 설치
   - 서버 설정 파일에 인증서 경로와 개인 키 경로 지정

5. 클라이언트에 인증서 설치
   - 클라이언트 시스템에 자체 서명 인증서를 신뢰할 수 있는 인증서로 추가

6. 서버 소프트웨어 설정
   - TLS 지원 설정 활성화
   - 포트 번호 및 프로토콜 설정

7. 테스트 및 검증
   - 클라이언트에서 서버로 연결 테스트
   - 인증서가 신뢰되도록 설정했기 때문에 경고 없이 암호화 통신 확인
